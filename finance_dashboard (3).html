<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1a5f4f;
            --primary-light: #2d7a67;
            --secondary: #f4a261;
            --accent: #e76f51;
            --success: #2d7a67;
            --warning: #f4a261;
            --danger: #e76f51;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #2a2a2a;
            --text-light: #6b6b6b;
            --border: #e5e5e5;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--text);
            line-height: 1.6;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 30px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle { text-align: center; opacity: 0.9; font-size: 1.1em; }

        /* Loading overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(26,95,79,0.92);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999; color: white;
        }

        #loadingOverlay h2 { font-family: 'Poppins', sans-serif; font-size: 1.8em; margin-bottom: 12px; }
        #loadingOverlay p { opacity: 0.85; }

        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Connection error banner */
        #dbError {
            display: none;
            background: #f8d7da;
            border-left: 5px solid var(--danger);
            color: #842029;
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* Tabs */
        .tabs {
            display: flex; gap: 10px; margin-bottom: 30px;
            flex-wrap: wrap; background: white;
            padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .tab {
            padding: 12px 24px; background: var(--bg);
            border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; transition: all 0.3s ease; font-size: 0.95em;
        }

        .tab:hover { background: var(--primary-light); color: white; transform: translateY(-2px); }

        .tab.active {
            background: var(--primary); color: white;
            box-shadow: 0 4px 12px rgba(26, 95, 79, 0.3);
        }

        .tab-content { display: none; }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }

        .card {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }

        .card-header {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3em; font-weight: 700;
            margin-bottom: 20px; color: var(--primary);
            display: flex; align-items: center; gap: 10px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--card) 0%, #f8f9fa 100%);
            border-left: 4px solid var(--primary);
        }

        .stat-label { font-size: 0.9em; color: var(--text-light); margin-bottom: 8px; }

        .stat-value {
            font-size: 2em; font-weight: 700;
            color: var(--primary); font-family: 'Poppins', sans-serif;
        }

        .stat-value.success { color: var(--success); }
        .stat-value.danger { color: var(--danger); }
        .stat-value.warning { color: var(--warning); }

        .form-group { margin-bottom: 20px; }

        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text); }

        input, select, textarea {
            width: 100%; padding: 12px; border: 2px solid var(--border);
            border-radius: 8px; font-size: 1em; transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 79, 0.1);
        }

        button {
            padding: 12px 30px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; font-size: 1em;
        }

        button:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 95, 79, 0.3);
        }

        button.danger { background: var(--danger); }
        button.danger:hover { background: #d55f42; }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }

        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); }

        th {
            background: var(--primary); color: white;
            font-weight: 600; font-size: 0.9em;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        tr:hover { background: #f8f9fa; }

        .badge {
            display: inline-block; padding: 5px 12px;
            border-radius: 20px; font-size: 0.85em; font-weight: 600;
        }

        .badge.success { background: #d5f4e6; color: var(--success); }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: var(--danger); }

        .alert {
            padding: 15px 20px; border-radius: 8px;
            margin-bottom: 20px; display: flex;
            align-items: center; gap: 10px; font-weight: 500;
        }

        .alert.warning { background: #fff3cd; border-left: 4px solid var(--warning); color: #856404; }
        .alert.danger { background: #f8d7da; border-left: 4px solid var(--danger); color: var(--danger); }
        .alert.success { background: #d5f4e6; border-left: 4px solid var(--success); color: var(--success); }

        .progress-bar {
            width: 100%; height: 25px; background: #e9ecef;
            border-radius: 12px; overflow: hidden; margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
            transition: width 0.5s ease;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 0.85em;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 15px; border-radius: 8px; margin: 10px 0;
        }

        .ai-suggestion strong { color: #1976d2; }

        .emi-alert {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid var(--warning);
            padding: 20px; border-radius: 12px; margin: 15px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244, 162, 97, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(244, 162, 97, 0); }
        }

        .goal-timeline {
            display: flex; align-items: center; gap: 15px;
            padding: 15px; background: #f8f9fa;
            border-radius: 8px; margin: 10px 0;
        }

        .goal-icon { font-size: 2em; }
        .goal-info { flex: 1; }
        .goal-name { font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        .goal-stats { font-size: 0.9em; color: var(--text-light); }

        .months-badge {
            background: var(--primary); color: white;
            padding: 8px 16px; border-radius: 20px;
            font-weight: 700; font-size: 1.1em;
        }

        .section-header {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5em; font-weight: 700;
            color: var(--primary); margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary);
        }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; opacity: 0.3; }

        .delete-btn {
            background: var(--danger); color: white;
            border: none; padding: 6px 14px;
            border-radius: 5px; cursor: pointer; font-size: 0.85em;
        }

        .delete-btn:hover { background: #d55f42; }
        .delete-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .toast {
            position: fixed; bottom: 30px; right: 30px;
            padding: 14px 24px; border-radius: 10px;
            font-weight: 600; font-size: 0.95em;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 8888;
            animation: slideUp 0.4s ease;
            max-width: 350px;
        }

        .toast.success { background: var(--success); color: white; }
        .toast.error { background: var(--danger); color: white; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.8em; }
            .tabs { flex-direction: column; }
            .tab { width: 100%; }
        }
    </style>
</head>
<body>

<!-- Loading overlay -->
<div id="loadingOverlay">
    <div class="spinner"></div>
    <h2>üí∞ Finance Dashboard</h2>
    <p>Connecting to database...</p>
</div>

<header>
    <div class="container">
        <h1>üí∞ Personal Finance Dashboard</h1>
        <p class="subtitle">Track your money, achieve your goals, build wealth</p>
    </div>
</header>

<div class="container">
    <!-- DB Error Banner -->
    <div id="dbError">
        ‚ö†Ô∏è <strong>Database connection failed.</strong> Please check your Supabase URL and Anon Key in the script at the bottom of this file, and ensure your tables are created.
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard', this)">üìä Dashboard</button>
        <button class="tab" onclick="showTab('income', this)">üíµ Income</button>
        <button class="tab" onclick="showTab('expenses', this)">üí≥ Expenses</button>
        <button class="tab" onclick="showTab('budget', this)">üìà Budget</button>
        <button class="tab" onclick="showTab('emi', this)">üìÖ EMI Tracker</button>
        <button class="tab" onclick="showTab('goals', this)">üéØ Savings Goals</button>
        <button class="tab" onclick="showTab('ai', this)">ü§ñ AI Advisor</button>
    </div>

    <!-- ========== DASHBOARD ========== -->
    <div id="dashboard" class="tab-content active">
        <div class="grid">
            <div class="card stat-card">
                <div class="stat-label">Total Income</div>
                <div class="stat-value success" id="totalIncome">‚Çπ0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">Total Expenses</div>
                <div class="stat-value danger" id="totalExpenses">‚Çπ0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">Total EMI Payments</div>
                <div class="stat-value warning" id="totalEMI">‚Çπ0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">Net Savings</div>
                <div class="stat-value" id="netSavings">‚Çπ0</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header">üíº Budget Status</div>
                <div class="stat-label">Total Monthly Budget</div>
                <div class="stat-value" id="totalBudget">‚Çπ0</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="budgetProgress" style="width:0%">0%</div>
                </div>
                <p style="margin-top:10px;color:var(--text-light);">
                    <span id="budgetRemaining">‚Çπ0</span> remaining
                </p>
            </div>
            <div class="card">
                <div class="card-header">üìä Savings Rate</div>
                <div class="stat-value" id="savingsRate">0%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="savingsProgress" style="width:0%">0%</div>
                </div>
                <p style="margin-top:10px;color:var(--text-light);" id="healthStatus">Building wealth...</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">üîî EMI Alerts ‚Äì Due in Next 5 Days</div>
            <div id="emiAlerts"></div>
        </div>

        <div class="card">
            <div class="card-header">üíé Savings Goals Timeline</div>
            <div id="goalsSummary"></div>
        </div>
    </div>

    <!-- ========== INCOME ========== -->
    <div id="income" class="tab-content">
        <div class="card">
            <div class="card-header">üíµ Add Income</div>
            <form id="incomeForm">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="incomeDate" required>
                </div>
                <div class="form-group">
                    <label>Source (e.g., Salary, Freelance)</label>
                    <input type="text" id="incomeSource" placeholder="Enter income source" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="incomeDescription" placeholder="Enter description">
                </div>
                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="incomeAmount" placeholder="Enter amount" required min="0" step="0.01">
                </div>
                <button type="submit" id="incomeSubmitBtn">Add Income</button>
            </form>
        </div>
        <div class="card">
            <div class="card-header">üìã Income History</div>
            <div id="incomeList"></div>
        </div>
    </div>

    <!-- ========== EXPENSES ========== -->
    <div id="expenses" class="tab-content">
        <div class="card">
            <div class="card-header">üí≥ Add Expense</div>
            <form id="expenseForm">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="expenseCategory" required>
                        <option value="">Select Category</option>
                        <option value="Groceries">Groceries</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Dining Out">Dining Out</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expenseDescription" placeholder="Enter description" required>
                </div>
                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="expenseAmount" placeholder="Enter amount" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="expensePayment" required>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="UPI">UPI</option>
                        <option value="Net Banking">Net Banking</option>
                    </select>
                </div>
                <button type="submit" id="expenseSubmitBtn">Add Expense</button>
            </form>
        </div>
        <div class="card">
            <div class="card-header">üìã Expense History</div>
            <div id="expenseList"></div>
        </div>
    </div>

    <!-- ========== BUDGET ========== -->
    <div id="budget" class="tab-content">
        <div class="card">
            <div class="card-header">üìà Set Monthly Budget</div>
            <form id="budgetForm">
                <div class="form-group">
                    <label>Category</label>
                    <select id="budgetCategory" required>
                        <option value="Groceries">Groceries</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Dining Out">Dining Out</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monthly Budget Amount (‚Çπ)</label>
                    <input type="number" id="budgetAmount" placeholder="Enter budget amount" required min="0" step="0.01">
                </div>
                <button type="submit" id="budgetSubmitBtn">Set Budget</button>
            </form>
        </div>
        <div class="card">
            <div class="card-header">üìä Budget vs Actual Spending</div>
            <div id="budgetComparison"></div>
        </div>
    </div>

    <!-- ========== EMI ========== -->
    <div id="emi" class="tab-content">
        <div class="alert warning">
            <span>‚ö†Ô∏è</span>
            <span>EMI alerts will highlight payments due within the next 5 days on the Dashboard.</span>
        </div>
        <div class="card">
            <div class="card-header">üìÖ Add EMI</div>
            <form id="emiForm">
                <div class="form-group">
                    <label>EMI Name (e.g., Home Loan, Car Loan)</label>
                    <input type="text" id="emiName" placeholder="Enter EMI name" required>
                </div>
                <div class="form-group">
                    <label>Next Payment Date</label>
                    <input type="date" id="emiDate" required>
                </div>
                <div class="form-group">
                    <label>Principal Amount (‚Çπ)</label>
                    <input type="number" id="emiPrincipal" placeholder="Enter principal amount" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Monthly EMI Amount (‚Çπ)</label>
                    <input type="number" id="emiAmount" placeholder="Enter monthly EMI" required min="0" step="0.01">
                </div>
                <button type="submit" id="emiSubmitBtn">Add EMI</button>
            </form>
        </div>
        <div class="card">
            <div class="card-header">üìã EMI List</div>
            <div id="emiList"></div>
        </div>
    </div>

    <!-- ========== SAVINGS GOALS ========== -->
    <div id="goals" class="tab-content">
        <div class="card">
            <div class="card-header">üéØ Add Savings Goal</div>
            <form id="goalForm">
                <div class="form-group">
                    <label>Goal Name (e.g., Emergency Fund, New Car)</label>
                    <input type="text" id="goalName" placeholder="Enter goal name" required>
                </div>
                <div class="form-group">
                    <label>Target Amount (‚Çπ)</label>
                    <input type="number" id="goalTarget" placeholder="Enter target amount" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Current Saved (‚Çπ)</label>
                    <input type="number" id="goalCurrent" placeholder="Amount already saved" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Monthly Saving Amount (‚Çπ)</label>
                    <input type="number" id="goalMonthly" placeholder="How much you'll save per month" required min="0" step="0.01">
                </div>
                <button type="submit" id="goalSubmitBtn">Add Goal</button>
            </form>
        </div>
        <div class="card">
            <div class="card-header">üíé Your Savings Goals &amp; Timeline</div>
            <div id="goalsList"></div>
        </div>
    </div>

    <!-- ========== AI ADVISOR ========== -->
    <div id="ai" class="tab-content">
        <div class="card">
            <div class="card-header">ü§ñ Your Financial Health Score</div>
            <div class="grid">
                <div>
                    <div class="stat-label">Savings Rate</div>
                    <div class="stat-value success" id="aiSavingsRate">0%</div>
                </div>
                <div>
                    <div class="stat-label">Health Status</div>
                    <div class="stat-value" id="aiHealthStatus" style="font-size:1.5em;">-</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">üí° Budget Optimization Suggestions</div>
            <div id="aiSuggestions"></div>
        </div>
        <div class="card">
            <div class="card-header">üí∞ Investment Opportunities</div>
            <div id="investmentSuggestions"></div>
        </div>
        <div class="card">
            <div class="card-header">üìà Wealth Building Tips</div>
            <div class="ai-suggestion"><strong>1. Follow 50-30-20 Rule:</strong> 50% Needs, 30% Wants, 20% Savings</div>
            <div class="ai-suggestion"><strong>2. Emergency Fund:</strong> Build 6 months of expenses for financial security</div>
            <div class="ai-suggestion"><strong>3. Start Investing Early:</strong> Even ‚Çπ500/month SIP can grow significantly over time</div>
            <div class="ai-suggestion"><strong>4. Pay High-Interest Debt First:</strong> Reduce financial burden by clearing expensive loans</div>
            <div class="ai-suggestion"><strong>5. Review Monthly:</strong> Track spending patterns and adjust budgets regularly</div>
        </div>
    </div>
</div>

<script>
// =====================================================
// ‚öôÔ∏è  SUPABASE CONFIGURATION
// Paste your Project URL and Anon Key below.
// =====================================================
const SUPABASE_URL  = 'https://yfahcrsahzadaovwdbvy.supabase.co';   // e.g. https://abcdefgh.supabase.co
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmYWhjcnNhaHphZGFvdndkYnZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDQ5NjEsImV4cCI6MjA4NjQ4MDk2MX0.rJ7zq5NqDUsrQr_07eJEVZxzbQkowJ9UxNSO1ZBn_cg';  // starts with eyJ...

// =====================================================
// REQUIRED SUPABASE SQL (run once in your SQL Editor)
// =====================================================
/*
create table if not exists income (
  id          bigint generated always as identity primary key,
  date        date not null,
  source      text not null,
  description text,
  amount      numeric(12,2) not null,
  created_at  timestamptz default now()
);

create table if not exists expenses (
  id             bigint generated always as identity primary key,
  date           date not null,
  category       text not null,
  description    text not null,
  amount         numeric(12,2) not null,
  payment_method text not null,
  created_at     timestamptz default now()
);

create table if not exists budgets (
  id       bigint generated always as identity primary key,
  category text unique not null,
  amount   numeric(12,2) not null
);

create table if not exists emis (
  id          bigint generated always as identity primary key,
  name        text not null,
  date        date not null,
  principal   numeric(12,2) not null,
  amount      numeric(12,2) not null,
  created_at  timestamptz default now()
);

create table if not exists goals (
  id          bigint generated always as identity primary key,
  name        text not null,
  target      numeric(12,2) not null,
  current     numeric(12,2) not null,
  monthly     numeric(12,2) not null,
  created_at  timestamptz default now()
);
*/

// =====================================================
// INIT
// =====================================================
const { createClient } = supabase;
let db;

// In-memory state
let incomeData  = [];
let expenseData = [];
let budgetData  = {};
let emiData     = [];
let goalsData   = [];

const DEFAULT_BUDGETS = {
    'Groceries': 15000, 'Transportation': 5000, 'Dining Out': 8000,
    'Utilities': 3000,  'Entertainment': 5000,  'Healthcare': 3000,
    'Shopping': 10000,  'Other': 5000
};

// =====================================================
// STARTUP
// =====================================================
async function init() {
    // Validate credentials
    if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
        document.getElementById('dbError').style.display = 'block';
        document.getElementById('dbError').innerHTML =
            '‚öôÔ∏è <strong>Setup required:</strong> Open this file and replace <code>YOUR_SUPABASE_PROJECT_URL</code> and <code>YOUR_SUPABASE_ANON_KEY</code> with your actual Supabase credentials.';
        hideLoading();
        return;
    }

    try {
        db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        await loadAll();
    } catch (err) {
        showDbError(err.message);
    }

    hideLoading();
    setDefaultDates();
    updateDashboard();
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 0.4s';
    setTimeout(() => overlay.style.display = 'none', 400);
}

function showDbError(msg) {
    const el = document.getElementById('dbError');
    el.style.display = 'block';
    el.innerHTML = `‚ö†Ô∏è <strong>Database error:</strong> ${msg}. Check your credentials and table setup.`;
}

// =====================================================
// LOAD ALL DATA
// =====================================================
async function loadAll() {
    const [inc, exp, bud, emi, gls] = await Promise.all([
        db.from('income').select('*').order('date', { ascending: false }),
        db.from('expenses').select('*').order('date', { ascending: false }),
        db.from('budgets').select('*'),
        db.from('emis').select('*').order('date', { ascending: true }),
        db.from('goals').select('*').order('created_at', { ascending: true })
    ]);

    if (inc.error)  throw new Error('income: ' + inc.error.message);
    if (exp.error)  throw new Error('expenses: ' + exp.error.message);
    if (bud.error)  throw new Error('budgets: ' + bud.error.message);
    if (emi.error)  throw new Error('emis: ' + emi.error.message);
    if (gls.error)  throw new Error('goals: ' + gls.error.message);

    incomeData  = inc.data  || [];
    expenseData = exp.data  || [];
    emiData     = emi.data  || [];
    goalsData   = gls.data  || [];

    // Convert budgets array ‚Üí object
    budgetData = { ...DEFAULT_BUDGETS };
    (bud.data || []).forEach(row => { budgetData[row.category] = parseFloat(row.amount); });
}

// =====================================================
// TAB SWITCHING
// =====================================================
function showTab(tabName, btnEl) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    if (btnEl) btnEl.classList.add('active');

    // Refresh relevant list
    if (tabName === 'dashboard') updateDashboard();
    if (tabName === 'income')    renderIncomeList();
    if (tabName === 'expenses')  renderExpenseList();
    if (tabName === 'budget')    renderBudgetComparison();
    if (tabName === 'emi')       renderEMIList();
    if (tabName === 'goals')     renderGoalsList();
    if (tabName === 'ai')        updateAIAdvisor();
}

// =====================================================
// UTILITIES
// =====================================================
function fmt(amount) {
    return '‚Çπ' + parseFloat(amount || 0).toLocaleString('en-IN', { maximumFractionDigits: 0 });
}

function setDefaultDates() {
    const today = new Date().toISOString().split('T')[0];
    ['incomeDate', 'expenseDate', 'emiDate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
    });
}

function toast(msg, type = 'success') {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const div = document.createElement('div');
    div.className = `toast ${type}`;
    div.textContent = msg;
    document.body.appendChild(div);
    setTimeout(() => { div.style.opacity = '0'; div.style.transition = 'opacity 0.4s'; setTimeout(() => div.remove(), 400); }, 3000);
}

function setLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    btn.disabled = loading;
    btn.textContent = loading ? 'Saving...' : btn.dataset.label || btn.textContent;
}

// =====================================================
// CALCULATIONS
// =====================================================
function calcTotals() {
    const totalIncome   = incomeData.reduce((s, i) => s + parseFloat(i.amount), 0);
    const totalExpenses = expenseData.reduce((s, e) => s + parseFloat(e.amount), 0);
    const totalEMI      = emiData.reduce((s, e) => s + parseFloat(e.amount), 0);
    const netSavings    = totalIncome - totalExpenses - totalEMI;
    const savingsRate   = totalIncome > 0 ? (netSavings / totalIncome * 100).toFixed(1) : 0;
    const totalBudget   = Object.values(budgetData).reduce((s, v) => s + v, 0);
    return { totalIncome, totalExpenses, totalEMI, netSavings, savingsRate, totalBudget };
}

// =====================================================
// DASHBOARD
// =====================================================
function updateDashboard() {
    const t = calcTotals();

    document.getElementById('totalIncome').textContent   = fmt(t.totalIncome);
    document.getElementById('totalExpenses').textContent = fmt(t.totalExpenses);
    document.getElementById('totalEMI').textContent      = fmt(t.totalEMI);
    document.getElementById('netSavings').textContent    = fmt(t.netSavings);
    document.getElementById('netSavings').className      = 'stat-value ' + (t.netSavings >= 0 ? 'success' : 'danger');

    document.getElementById('totalBudget').textContent   = fmt(t.totalBudget);
    const budgetUsed = t.totalBudget > 0 ? (t.totalExpenses / t.totalBudget * 100).toFixed(1) : 0;
    document.getElementById('budgetProgress').style.width   = Math.min(budgetUsed, 100) + '%';
    document.getElementById('budgetProgress').textContent   = budgetUsed + '%';
    document.getElementById('budgetRemaining').textContent  = fmt(t.totalBudget - t.totalExpenses);

    document.getElementById('savingsRate').textContent       = t.savingsRate + '%';
    document.getElementById('savingsProgress').style.width  = Math.min(t.savingsRate, 100) + '%';
    document.getElementById('savingsProgress').textContent  = t.savingsRate + '%';

    let hs = t.savingsRate >= 30 ? 'üíö Excellent' :
             t.savingsRate >= 20 ? 'üíõ Good'      :
             t.savingsRate >= 10 ? 'üß° Fair'       : '‚ù§Ô∏è Needs Improvement';
    document.getElementById('healthStatus').textContent = hs;

    renderEMIAlerts();
    renderGoalsSummary();
}

function renderEMIAlerts() {
    const div = document.getElementById('emiAlerts');
    const today = new Date();
    const alerts = emiData.filter(emi => {
        const d = Math.ceil((new Date(emi.date) - today) / 86400000);
        return d >= 0 && d <= 5;
    });

    if (!alerts.length) {
        div.innerHTML = '<p style="color:var(--text-light);">No upcoming EMI payments in the next 5 days ‚úÖ</p>';
        return;
    }

    div.innerHTML = alerts.map(emi => {
        const d = Math.ceil((new Date(emi.date) - today) / 86400000);
        return `<div class="emi-alert">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong style="font-size:1.2em;">${emi.name}</strong>
                    <p>Payment Date: ${emi.date} | Amount: ${fmt(emi.amount)}</p>
                    <p style="color:var(--danger);font-weight:600;">‚ö†Ô∏è Due in ${d} day(s)!</p>
                </div>
                <div class="badge danger">PAY SOON</div>
            </div>
        </div>`;
    }).join('');
}

function renderGoalsSummary() {
    const div = document.getElementById('goalsSummary');
    if (!goalsData.length) {
        div.innerHTML = '<p style="color:var(--text-light);">No savings goals set yet. Go to Savings Goals tab to add!</p>';
        return;
    }

    div.innerHTML = goalsData.slice(0, 5).map(g => {
        const rem = g.target - g.current;
        const months = g.monthly > 0 ? Math.ceil(rem / g.monthly) : '‚àû';
        const pct = Math.min((g.current / g.target * 100), 100).toFixed(1);
        return `<div class="goal-timeline">
            <div class="goal-icon">üéØ</div>
            <div class="goal-info">
                <div class="goal-name">${g.name}</div>
                <div class="goal-stats">${fmt(g.current)} / ${fmt(g.target)} (${pct}% complete)</div>
                <div class="progress-bar" style="margin-top:8px;">
                    <div class="progress-fill" style="width:${pct}%">${pct}%</div>
                </div>
            </div>
            <div class="months-badge">${months} months</div>
        </div>`;
    }).join('');
}

// =====================================================
// INCOME
// =====================================================
document.getElementById('incomeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('incomeSubmitBtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    const item = {
        date:        document.getElementById('incomeDate').value,
        source:      document.getElementById('incomeSource').value,
        description: document.getElementById('incomeDescription').value,
        amount:      parseFloat(document.getElementById('incomeAmount').value)
    };

    const { data, error } = await db.from('income').insert([item]).select();
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); }
    else {
        incomeData.unshift(data[0]);
        e.target.reset();
        setDefaultDates();
        renderIncomeList();
        updateDashboard();
        toast('‚úÖ Income added successfully!');
    }

    btn.disabled = false; btn.textContent = 'Add Income';
});

function renderIncomeList() {
    const div = document.getElementById('incomeList');
    if (!incomeData.length) {
        div.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üíµ</div><p>No income entries yet</p></div>';
        return;
    }

    div.innerHTML = `<table>
        <tr><th>Date</th><th>Source</th><th>Description</th><th>Amount</th><th>Action</th></tr>
        ${incomeData.map(i => `<tr>
            <td>${i.date}</td>
            <td><strong>${i.source}</strong></td>
            <td>${i.description || '-'}</td>
            <td style="color:var(--success);font-weight:700;">${fmt(i.amount)}</td>
            <td><button class="delete-btn" onclick="deleteIncome(${i.id})">Delete</button></td>
        </tr>`).join('')}
    </table>`;
}

async function deleteIncome(id) {
    if (!confirm('Delete this income entry?')) return;
    const { error } = await db.from('income').delete().eq('id', id);
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); return; }
    incomeData = incomeData.filter(i => i.id !== id);
    renderIncomeList();
    updateDashboard();
    toast('üóëÔ∏è Income deleted');
}

// =====================================================
// EXPENSES
// =====================================================
document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('expenseSubmitBtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    const item = {
        date:           document.getElementById('expenseDate').value,
        category:       document.getElementById('expenseCategory').value,
        description:    document.getElementById('expenseDescription').value,
        amount:         parseFloat(document.getElementById('expenseAmount').value),
        payment_method: document.getElementById('expensePayment').value
    };

    const { data, error } = await db.from('expenses').insert([item]).select();
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); }
    else {
        expenseData.unshift(data[0]);
        e.target.reset();
        setDefaultDates();
        renderExpenseList();
        updateDashboard();
        toast('‚úÖ Expense added successfully!');
    }

    btn.disabled = false; btn.textContent = 'Add Expense';
});

function renderExpenseList() {
    const div = document.getElementById('expenseList');
    if (!expenseData.length) {
        div.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí≥</div><p>No expenses yet</p></div>';
        return;
    }

    div.innerHTML = `<table>
        <tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Payment</th><th>Action</th></tr>
        ${expenseData.map(ex => `<tr>
            <td>${ex.date}</td>
            <td><span class="badge success">${ex.category}</span></td>
            <td>${ex.description}</td>
            <td style="color:var(--danger);font-weight:700;">${fmt(ex.amount)}</td>
            <td>${ex.payment_method}</td>
            <td><button class="delete-btn" onclick="deleteExpense(${ex.id})">Delete</button></td>
        </tr>`).join('')}
    </table>`;
}

async function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    const { error } = await db.from('expenses').delete().eq('id', id);
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); return; }
    expenseData = expenseData.filter(e => e.id !== id);
    renderExpenseList();
    updateDashboard();
    toast('üóëÔ∏è Expense deleted');
}

// =====================================================
// BUDGET
// =====================================================
document.getElementById('budgetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('budgetSubmitBtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    const category = document.getElementById('budgetCategory').value;
    const amount   = parseFloat(document.getElementById('budgetAmount').value);

    const { error } = await db.from('budgets')
        .upsert([{ category, amount }], { onConflict: 'category' });

    if (error) { toast('‚ùå Error: ' + error.message, 'error'); }
    else {
        budgetData[category] = amount;
        e.target.reset();
        renderBudgetComparison();
        updateDashboard();
        toast('‚úÖ Budget updated successfully!');
    }

    btn.disabled = false; btn.textContent = 'Set Budget';
});

function renderBudgetComparison() {
    const div = document.getElementById('budgetComparison');

    div.innerHTML = `<table>
        <tr><th>Category</th><th>Budget</th><th>Spent</th><th>Remaining</th><th>Status</th></tr>
        ${Object.keys(budgetData).map(cat => {
            const budget  = budgetData[cat];
            const spent   = expenseData.filter(e => e.category === cat).reduce((s, e) => s + parseFloat(e.amount), 0);
            const remaining = budget - spent;
            const pct = (spent / budget * 100).toFixed(1);
            const badge = spent > budget * 1.2 ? '<span class="badge danger">‚ö†Ô∏è Over Budget</span>' :
                          spent > budget * 0.8  ? '<span class="badge warning">‚ö° Close</span>'       :
                                                  '<span class="badge success">‚úÖ Good</span>';
            return `<tr>
                <td><strong>${cat}</strong></td>
                <td>${fmt(budget)}</td>
                <td style="color:var(--danger);font-weight:600;">${fmt(spent)}</td>
                <td style="color:${remaining >= 0 ? 'var(--success)' : 'var(--danger)'};font-weight:600;">${fmt(remaining)}</td>
                <td>${badge}</td>
            </tr>`;
        }).join('')}
    </table>`;
}

// =====================================================
// EMI
// =====================================================
document.getElementById('emiForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('emiSubmitBtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    const item = {
        name:      document.getElementById('emiName').value,
        date:      document.getElementById('emiDate').value,
        principal: parseFloat(document.getElementById('emiPrincipal').value),
        amount:    parseFloat(document.getElementById('emiAmount').value)
    };

    const { data, error } = await db.from('emis').insert([item]).select();
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); }
    else {
        emiData.push(data[0]);
        e.target.reset();
        setDefaultDates();
        renderEMIList();
        updateDashboard();
        toast('‚úÖ EMI added successfully!');
    }

    btn.disabled = false; btn.textContent = 'Add EMI';
});

function renderEMIList() {
    const div = document.getElementById('emiList');
    if (!emiData.length) {
        div.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No EMIs added yet</p></div>';
        return;
    }

    const today = new Date();
    div.innerHTML = `<table>
        <tr><th>EMI Name</th><th>Payment Date</th><th>Principal</th><th>Monthly EMI</th><th>Days Left</th><th>Action</th></tr>
        ${emiData.map(emi => {
            const daysUntil = Math.ceil((new Date(emi.date) - today) / 86400000);
            const status = daysUntil <= 0 ? '<span class="badge danger">OVERDUE</span>' :
                           daysUntil <= 5 ? '<span class="badge warning">DUE SOON</span>' :
                           `${daysUntil} days`;
            return `<tr>
                <td><strong>${emi.name}</strong></td>
                <td>${emi.date}</td>
                <td>${fmt(emi.principal)}</td>
                <td style="color:var(--danger);font-weight:700;">${fmt(emi.amount)}</td>
                <td>${status}</td>
                <td><button class="delete-btn" onclick="deleteEMI(${emi.id})">Delete</button></td>
            </tr>`;
        }).join('')}
    </table>`;
}

async function deleteEMI(id) {
    if (!confirm('Delete this EMI?')) return;
    const { error } = await db.from('emis').delete().eq('id', id);
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); return; }
    emiData = emiData.filter(e => e.id !== id);
    renderEMIList();
    updateDashboard();
    toast('üóëÔ∏è EMI deleted');
}

// =====================================================
// SAVINGS GOALS
// =====================================================
document.getElementById('goalForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('goalSubmitBtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    const item = {
        name:    document.getElementById('goalName').value,
        target:  parseFloat(document.getElementById('goalTarget').value),
        current: parseFloat(document.getElementById('goalCurrent').value),
        monthly: parseFloat(document.getElementById('goalMonthly').value)
    };

    const { data, error } = await db.from('goals').insert([item]).select();
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); }
    else {
        goalsData.push(data[0]);
        e.target.reset();
        renderGoalsList();
        updateDashboard();
        toast('‚úÖ Savings goal added successfully!');
    }

    btn.disabled = false; btn.textContent = 'Add Goal';
});

function renderGoalsList() {
    const div = document.getElementById('goalsList');
    if (!goalsData.length) {
        div.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéØ</div><p>No savings goals yet</p></div>';
        return;
    }

    div.innerHTML = goalsData.map(g => {
        const rem = g.target - g.current;
        const months = g.monthly > 0 ? Math.ceil(rem / g.monthly) : '‚àû';
        const pct = Math.min((g.current / g.target * 100), 100).toFixed(1);
        return `<div class="goal-timeline">
            <div class="goal-icon">üéØ</div>
            <div class="goal-info">
                <div class="goal-name">${g.name}</div>
                <div class="goal-stats">
                    Target: ${fmt(g.target)} | Saved: ${fmt(g.current)} | Remaining: ${fmt(rem)}
                </div>
                <div class="goal-stats">Monthly Saving: ${fmt(g.monthly)}</div>
                <div class="progress-bar" style="margin-top:8px;">
                    <div class="progress-fill" style="width:${pct}%">${pct}%</div>
                </div>
            </div>
            <div style="text-align:center;">
                <div class="months-badge">${months} months</div>
                <button class="delete-btn" style="margin-top:10px;" onclick="deleteGoal(${g.id})">Delete</button>
            </div>
        </div>`;
    }).join('');
}

async function deleteGoal(id) {
    if (!confirm('Delete this savings goal?')) return;
    const { error } = await db.from('goals').delete().eq('id', id);
    if (error) { toast('‚ùå Error: ' + error.message, 'error'); return; }
    goalsData = goalsData.filter(g => g.id !== id);
    renderGoalsList();
    updateDashboard();
    toast('üóëÔ∏è Goal deleted');
}

// =====================================================
// AI ADVISOR
// =====================================================
function updateAIAdvisor() {
    const t = calcTotals();

    document.getElementById('aiSavingsRate').textContent = t.savingsRate + '%';
    document.getElementById('aiHealthStatus').textContent =
        t.savingsRate >= 30 ? 'üíö Excellent (30%+)' :
        t.savingsRate >= 20 ? 'üíõ Good (20%+)'      :
        t.savingsRate >= 10 ? 'üß° Fair (10%+)'       : '‚ù§Ô∏è Poor ‚Äì Save More!';

    // Budget suggestions
    const sugDiv = document.getElementById('aiSuggestions');
    if (!Object.keys(budgetData).length) {
        sugDiv.innerHTML = '<p style="color:var(--text-light);">Set a budget first to see suggestions.</p>';
    } else {
        sugDiv.innerHTML = Object.keys(budgetData).map(cat => {
            const budget = budgetData[cat];
            const spent  = expenseData.filter(e => e.category === cat).reduce((s, e) => s + parseFloat(e.amount), 0);
            const suggestion =
                spent === 0              ? 'No spending yet ‚Äì Great start!' :
                spent > budget * 1.2     ? `‚ö†Ô∏è ALERT: Overspending by ${fmt(spent - budget)}! Cut back immediately.` :
                spent < budget * 0.7     ? `‚úÖ EXCELLENT! You can save ${fmt(budget - spent)} more this month.` :
                                           '‚úÖ Perfect pace! Stay on track.';
            return `<div class="ai-suggestion">
                <strong>${cat}:</strong> Budget: ${fmt(budget)}, Spent: ${fmt(spent)}<br>${suggestion}
            </div>`;
        }).join('');
    }

    // Investment suggestions
    const available = t.totalBudget - t.totalExpenses;
    let inv = `<p style="margin-bottom:15px;"><strong>Available for Investment:</strong> ${fmt(available)}</p>`;
    if (available >= 10000) inv += `<div class="ai-suggestion"><strong>Fixed Deposit (Safe):</strong> Low Risk ‚Äì 6-7% returns<br>‚úÖ Invest ${fmt(available * 0.3)} in FD for guaranteed returns</div>`;
    if (available >= 5000)  inv += `<div class="ai-suggestion"><strong>Mutual Funds SIP:</strong> Medium Risk ‚Äì 10-12% returns<br>‚úÖ Start SIP of ${fmt(available * 0.3)} per month</div>`;
    if (available >= 1000)  inv += `<div class="ai-suggestion"><strong>Recurring Deposit:</strong> Zero Risk ‚Äì 6% returns<br>‚úÖ Start RD of ${fmt(available * 0.2)} per month</div>`;
    if (available < 1000)   inv += '<p style="color:var(--danger);">‚ö†Ô∏è Increase your savings to unlock investment opportunities!</p>';
    document.getElementById('investmentSuggestions').innerHTML = inv;
}

// =====================================================
// KICK OFF
// =====================================================
init();
</script>
</body>
</html>
